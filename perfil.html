<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil · ConectaFisio360</title>
    <script type="module" src="js/app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* (mesmo CSS do seu perfil – mantenha o que você já tem) */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
        body { background:#0b1120; color:white; min-height:100vh; }
        header { display:flex; justify-content:space-between; align-items:center; padding:20px 5%; background:#0f172a; }
        .logo { font-size:22px; font-weight:700; background:linear-gradient(90deg,#3b82f6,#22d3ee); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        nav a { color:#cbd5e1; text-decoration:none; margin-left:25px; }
        .container { max-width:800px; margin:50px auto; background:#1e293b; border-radius:20px; padding:40px; }
        .avatar { width:120px; height:120px; background:#2563eb; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:50px; margin:0 auto 20px; border:4px solid #38bdf8; }
        .stats-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-top:30px; }
        .stat-box { background:#0f172a; padding:20px; border-radius:12px; text-align:center; }
        .stat-val { font-size:24px; font-weight:bold; color:#38bdf8; }
        .btn { padding:10px 20px; background:#2563eb; color:white; border-radius:30px; text-decoration:none; display:inline-block; margin-top:20px; }
    </style>
</head>
<body>
    <header>
        <div class="logo">ConectaFisio360</div>
        <nav>
            <a href="painel.html"><i class="fas fa-home"></i> Home</a>
            <a href="modelos3d.html"><i class="fas fa-cube"></i> Modelos 3D</a>
            <a href="cursos.html"><i class="fas fa-graduation-cap"></i> Cursos</a>
            <a href="estudos.html"><i class="fas fa-flask"></i> Estudos</a>
            <a href="perfil.html"><i class="fas fa-user"></i> Perfil</a>
            <a href="javascript:void(0);" onclick="logout()" style="color:#ef4444;"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </nav>
    </header>

    <div class="container">
        <div class="avatar" id="avatar">L</div>
        <h2 id="nomeUsuario" style="text-align:center;">Carregando...</h2>
        <p style="text-align:center; color:#94a3b8;" id="emailUsuario">carregando...</p>
        <p style="text-align:center; color:#94a3b8;" id="especialidadeUsuario">carregando...</p>

        <div class="stats-grid">
            <div class="stat-box"><span class="stat-val" id="levelText">--</span>Nível</div>
            <div class="stat-box"><span class="stat-val" id="contDesafios">0</span>Desafios</div>
            <div class="stat-box"><span class="stat-val" id="xpText">0</span>XP</div>
        </div>

        <div style="text-align:center;">
            <a href="painel.html" class="btn">Voltar ao painel</a>
        </div>
    </div>

    <script type="module">
        import { getLevel, getUsuarioAtual, getXpAtual, getDesafiosAtual, getPlanoUsuario } from './js/app.js';
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        async function carregarPerfil() {
            const user = getUsuarioAtual();
            if (!user) {
                // Se não estiver logado, redireciona após um pequeno delay (para dar tempo do Firebase carregar)
                setTimeout(() => {
                    if (!getUsuarioAtual()) window.location.href = 'login.html';
                }, 500);
                return;
            }

            // Atualiza XP, desafios e nível
            document.getElementById('xpText').innerText = getXpAtual();
            document.getElementById('contDesafios').innerText = getDesafiosAtual();
            document.getElementById('levelText').innerText = getLevel(getXpAtual());

            // Busca dados completos do Realtime Database
            const db = getDatabase();
            const userRef = ref(db, `usuarios/${user.uid}`);
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                const data = snapshot.val();
                document.getElementById('nomeUsuario').innerText = data.nome || 'Usuário';
                document.getElementById('avatar').innerText = data.avatar || (data.nome ? data.nome.charAt(0).toUpperCase() : 'U');
                document.getElementById('emailUsuario').innerHTML = `<i class="fas fa-envelope"></i> ${data.email || user.email}`;
                document.getElementById('especialidadeUsuario').innerHTML = `<i class="fas fa-stethoscope"></i> ${data.especialidade || 'Não informada'}`;
            }
        }

        // Tenta carregar imediatamente, mas se falhar, escuta o evento
        carregarPerfil();
        window.addEventListener('usuarioAtualizado', carregarPerfil);
    </script>
</body>
</html>
